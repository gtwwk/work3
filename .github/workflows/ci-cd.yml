name: CI/CD Pipeline for Mortgage Calculator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Deploy to production (simulation)
      run: |
        echo "üöÄ Deploying to production server..."
        echo "‚úÖ Tests passed successfully!"
        echo "üì¶ Deploying version: ${{ github.sha }}"
        echo "üîß Installing application on production server..."
        
        # –°–∏–º—É–ª—è—Ü–∏—è –¥–µ–ø–ª–æ—è - –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∏ –±—ã –∫–æ–º–∞–Ω–¥—ã
        # –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±
        python -c "
        from src.calculator import calculate_monthly_payment
        result = calculate_monthly_payment(1000000, 7, 10)
        print(f'‚úÖ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç! –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: {result} —Ä—É–±.')
        "
        
        echo "üéâ Deployment completed successfully!"

    - name: Send deployment notification
      run: |
        echo "üì¢ Deployment to production completed!"
        echo "Commit: ${{ github.sha }}"
        echo "By: ${{ github.actor }}"
        echo "Message: ${{ github.event.head_commit.message }}"